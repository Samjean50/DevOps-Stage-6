name: Application Deployment

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - 'auth-api/**'
      - 'users-api/**'
      - 'todos-api/**'
      - 'log-message-processor/**'
      - 'docker-compose.yml'
      - '.env.example'
  workflow_dispatch:

jobs:
  deploy-application:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get server IP from Terraform
        id: get-server-ip
        run: |
          # Install Terraform
          wget -O terraform.zip https://releases.hashicorp.com/terraform/1.5.0/terraform_1.5.0_linux_amd64.zip
          unzip terraform.zip
          sudo mv terraform /usr/local/bin/
          
          # Configure AWS
          export AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
          export AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          export AWS_DEFAULT_REGION=us-east-1
          
          # Get server IP
          cd infra/terraform
          terraform init
          SERVER_IP=$(terraform output -raw ec2_public_ip 2>/dev/null || echo "")
          
          if [ -z "$SERVER_IP" ]; then
            echo "❌ No server found! Run infrastructure workflow first."
            exit 1
          fi
          
          echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT
          echo "✅ Found server at $SERVER_IP"
          
          # Get SSH key
          terraform output -raw private_key > ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: pip install ansible

      - name: Deploy application with Ansible
        working-directory: infra/ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: False
        run: |
          ansible-playbook -i inventory/hosts.ini playbooks/deploy.yml \
            -e "ansible_user=ubuntu" \
            -e "ansible_ssh_private_key_file=~/.ssh/deploy_key.pem" \
            -e "github_repo=${{ github.repository }}" \
            -e "github_branch=main" \
            -e "force_deploy=true"

      - name: Verify deployment
        run: |
          echo "⏳ Waiting for application to start..."
          sleep 45
          
          SERVER_IP="${{ steps.get-server-ip.outputs.server_ip }}"
          
          if curl -s -o /dev/null -w "%{http_code}" http://$SERVER_IP | grep -q "200\|301\|302"; then
            echo "✅ Application is responding"
          else
            echo "⚠️ Application may still be starting"
          fi

      - name: Send deployment notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: '${{ job.status == ''success'' && ''✅'' || ''❌'' }} Application Deployment ${{ job.status }}'
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: DevOps Bot <${{ secrets.GMAIL_USERNAME }}>
          body: |
            Application deployment ${{ job.status }}!
            
            Server: http://${{ steps.get-server-ip.outputs.server_ip }}
            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
            
            View logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}